<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Basketball Hub - 동호회 모집하기</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&family=Oswald:wght@600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
    <style>
        :root {
            --primary-orange: #f37321;
            --dark-navy: #1a1d23;
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            color: #333;
            background-color: #f9f9f9;
            padding-top: 80px;
        }

        .main-nav {
            transition: all 0.4s ease;
            padding: 10px 0;
            background: white !important;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border-bottom: 1px solid #eee;
        }

        .navbar-brand {
            font-family: 'Oswald', sans-serif;
            font-size: 1.4rem;
            color: #222 !important;
        }

        /* 프로필 이미지 영역 스타일 */
        .profile-upload-section {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
        }

        .profile-preview-container {
            position: relative;
            width: 100px;
            height: 100px;
        }

        #profilePreview {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 1px solid #ddd;
            background-color: #f8f9fa;
        }

        /* 이미지 삭제 X 버튼 공통 스타일 */
        .img-delete-btn {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff4d4d;
            color: white;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            font-size: 14px;
            display: none; /* 평소엔 숨김 */
            justify-content: center;
            align-items: center;
            cursor: pointer;
            border: none;
            z-index: 5;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        /* 호버 시 삭제 버튼 표시 */
        .profile-preview-container:hover .img-delete-btn,
        .preview-item:hover .img-delete-btn {
            display: flex;
        }

        .form-label {
            font-weight: 700;
            color: #444;
            margin-bottom: 8px;
        }

        .form-label span {
            color: var(--primary-orange);
            margin-left: 3px;
        }

        .btn-orange {
            background: var(--primary-orange);
            color: white;
            border: none;
            transition: 0.3s;
        }

        .btn-orange:hover {
            background: #d65d10;
            color: white;
        }

        /* 하단 이미지 업로드 박스 */
        .upload-box {
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            background: white;
            transition: 0.3s;
        }

        .upload-box:hover {
            border-color: var(--primary-orange);
            background: #fffcf9;
        }

        .preview-item {
            position: relative;
            width: 80px;
            height: 80px;
        }

        .preview-item img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            border: 1px solid #eee;
        }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg fixed-top main-nav">
    <div class="container">
        <a class="navbar-brand fw-bold" href="/main">
            <img src="https://cdn-icons-png.flaticon.com/512/889/889455.png" alt="logo" width="30" class="me-2"> Basketball Hub
        </a>
    </div>
</nav>

<main class="form-wrapper">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="mb-4">
                    <h2 class="fw-bold mb-1">동호회 모집하기</h2>
                    <p class="text-muted">함께 농구를 즐길 멋진 동료들을 찾아보세요.</p>
                </div>

                <div class="card p-4 p-md-5 bg-white border-0 shadow-sm">
                    <form id="clubForm" enctype="multipart/form-data">

                        <div class="mb-4">
                            <label class="form-label">동호회 프로필 사진 <span>*</span></label>
                            <div class="profile-upload-section">
                                <div class="profile-preview-container">
                                    <img src="https://cdn-icons-png.flaticon.com/512/166/166258.png" id="profilePreview" alt="Profile">
                                    <button type="button" class="img-delete-btn" id="delProfileBtn"><i class="bi bi-x"></i></button>
                                </div>
                                <div>
                                    <button type="button" class="btn btn-orange px-3 fw-bold" onclick="$('#profileInput').click();">
                                        <i class="bi bi-camera me-1"></i> 사진 업로드
                                    </button>
                                    <p class="small text-muted mt-2 mb-0">JPG, PNG 파일 (최대 5MB)</p>
                                </div>
                                <input type="file" id="profileInput" name="profileImage" class="d-none" accept="image/*">
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="form-label">동호회 이름<span>*</span></label>
                            <input type="text" name="clubName" class="form-control" placeholder="예: 시흥 슬램덩크" required>
                        </div>

                        <div class="mb-4">
                            <label class="form-label">활동 지역<span>*</span> </label>
                            <input type="text" name="location" class="form-control" placeholder="클릭하여 주소를 선택하세요" required readonly>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-4">
                                <label class="form-label">정기 모임 요일<span>*</span></label>
                                <select name="meetingDay" class="form-select">
                                    <option value="">선택해주세요</option>
                                    <option>월요일</option>
                                    <option>화요일</option>
                                    <option>수요일</option>
                                    <option>목요일</option>
                                    <option>금요일</option>
                                    <option>토요일</option>
                                    <option>일요일</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-4">
                                <label class="form-label">정기 모임 시간<span>*</span></label>
                                <input type="text" name="meetingTime" class="form-control" placeholder="예: 18:00 ~ 21:00">
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="form-label">동호회 소개</label>
                            <textarea name="content" class="form-control" rows="5" placeholder="동호회의 분위기, 활동 내용 등을 자유롭게 작성해주세요"></textarea>
                        </div>

                        <div class="p-4 mb-4" style="background-color: #fff9f4; border: 1px solid #ffe8d6; border-radius: 10px;">
                            <h6 class="fw-bold mb-3"><i class="bi bi-lock-fill me-1"></i> 동호회 가입 비밀번호</h6>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="small fw-bold mb-1">비밀번호 <span>*</span></label>
                                    <input type="password" id="passwordInput" class="form-control" placeholder="4자 이상 입력">
                                </div>
                                <div class="col-md-6">
                                    <label class="small fw-bold mb-1">비밀번호 확인 <span>*</span></label>
                                    <input type="password" id="passwordConfirmInput" class="form-control" placeholder="비밀번호 재입력">
                                </div>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="form-label">회비</label>
                            <input type="text" name="fee" class="form-control" placeholder="예: 월 20,000원">
                        </div>

                        <div class="mb-4">
                            <label class="form-label">연락처<span>*</span></label>
                            <input type="text" name="contact" class="form-control" placeholder="전화번호 또는 카카오톡 ID">
                        </div>

                        <div class="mb-5">
                            <label class="form-label">추가 사진 (최대 5장)</label>
                            <div class="upload-box" onclick="$('#fileInput').click();">
                                <i class="bi bi-images fs-3"></i>
                                <p class="mb-0 text-muted">클릭하여 사진을 업로드하세요</p>
                            </div>
                            <input type="file" id="fileInput" name="images" multiple class="d-none" accept="image/*">
                            <div id="previewArea" class="mt-3 d-flex flex-wrap gap-2"></div>
                        </div>

                        <div class="row g-3">
                            <div class="col-6">
                                <button type="button" class="btn btn-light w-100 py-3 fw-bold border" onclick="history.back();">취소</button>
                            </div>
                            <div class="col-6">
                                <button type="submit" class="btn btn-orange text-white w-100 py-3 fw-bold shadow-sm">등록하기</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</main>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<script>
    $(document).ready(function() {
        let profileFile = null; // 상단 프로필용 변수
        let fileList = [];      // 하단 다중 이미지용 배열

        // --- 1. 상단 프로필 사진 로직 ---
        $('#profileInput').on('change', function(e) {
            let file = e.target.files[0];
            if (file) {
                profileFile = file;
                let reader = new FileReader();
                reader.onload = function(event) {
                    $('#profilePreview').attr('src', event.target.result);
                }
                reader.readAsDataURL(file);
            }
        });

        // 프로필 사진 삭제 버튼
        $('#delProfileBtn').on('click', function(e) {
            e.stopPropagation();
            profileFile = null;
            $('#profileInput').val('');
            // 기본 이미지로 복구
            $('#profilePreview').attr('src', 'https://cdn-icons-png.flaticon.com/512/166/166258.png');
        });


        // --- 2. 하단 다중 이미지 로직 ---
        $('#fileInput').on('change', function(e) {
            let files = Array.from(e.target.files);

            files.forEach(file => {
                if (fileList.length < 5) {
                    fileList.push(file);
                }
            });
            renderPreviews();
            $(this).val(''); // 파일 초기화 (같은 파일 다시 올릴 수 있게)
        });

        // 미리보기 렌더링 함수
        function renderPreviews() {
            $('#previewArea').empty();
            fileList.forEach((file, index) => {
                let reader = new FileReader();
                reader.onload = function(e) {
                    let html = `
                        <div class="preview-item">
                            <img src="${e.target.result}">
                            <button type="button" class="img-delete-btn" onclick="removeSubFile(${index})">
                                <i class="bi bi-x"></i>
                            </button>
                        </div>`;
                    $('#previewArea').append(html);
                }
                reader.readAsDataURL(file);
            });
        }

        // 하단 사진 삭제 함수
        window.removeSubFile = function(index) {
            fileList.splice(index, 1);
            renderPreviews();
        };


        // --- 주소 API ---
        $("input[name='location']").on('click', function(){
            new daum.Postcode({
                oncomplete : function(data){
                    let address = (data.userSelectedType === 'R') ? data.roadAddress : data.jibunAddress;
                    $("input[name='location']").val(address);
                }
            }).open();
        });


        // --- AJAX 제출 로직 (주석 처리됨) ---
        $("#clubForm").on("submit", function(e){
            e.preventDefault();

            // 데이터 수집
            let clubName = $("input[name='clubName']").val();
            let location = $("input[name='location']").val();
            let meetingDay = $("select[name='meetingDay']").val();
            let meetingTime = $("input[name='meetingTime']").val();
            let content = $("textarea[name='content']").val();
            let fee = $("input[name='fee']").val();
            let contact = $("input[name='contact']").val();
            let password = $("#passwordInput").val();
            let pwConfirm = $("#passwordConfirmInput").val();

            // 비밀번호 체크
            if(password !== pwConfirm) {
                alert("비밀번호가 일치하지 않습니다.");
                return;
            }

            let formData = new FormData();
            formData.append("clubName", clubName);
            formData.append("activityArea", location);
            formData.append("meetingDay", meetingDay);
            formData.append("meetingTime", meetingTime);
            formData.append("introduce", content);
            formData.append("price", fee);
            formData.append("phoneNumber", contact);
            formData.append("password", password);

            // 상단 프로필 이미지 추가 (파일이 있을 경우만)
            if (profileFile) {
                formData.append("profileImage", profileFile);
            }

            // 하단 다중 이미지 추가 (fileList 배열 순회)
            // for문에서 forEach(file)로 바꾼 이유 : 사실상 성능상에 문제가 없다.
            // 가독성이 좋아지고 file.length를 잘못 등호를 잘못설정하면 범위가 꼬일수도 있다.
            fileList.forEach(file => {
                formData.append("images", file);
            });


            $.ajax({
                type: "POST",
                url: "/club",
                data: formData,
                contentType: false,
                processData: false,
                success: function(response){
                    if(response.result === "success"){
                        alert("동호회가 등록되었습니다!");
                        window.location.href = "/main";
                    } else {
                        alert("등록에 실패했습니다.");
                    }
                },
                error: function(){
                    alert("서버 통신 오류가 발생했습니다.");
                }
            });


            // console.log("FormData 구성 완료 - 콘솔에서 확인 가능");
            // for (let pair of formData.entries()) {
            //     console.log(pair[0] + ': ' + pair[1]);
            // }
        });

    });
</script>
</body>
</html>