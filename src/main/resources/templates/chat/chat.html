<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messenger UI - jQuery Version</title>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <style>
        :root {
            --bg-color: #f5f5f5;
            --white: #ffffff;
            --primary-orange: #e67e22;
            --hover-bg: #fff8f0;
            --text-gray: #888;
            --border-color: #eee;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Pretendard', sans-serif;
        }

        body {
            background-color: var(--bg-color);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        .container {
            width: 1000px;
            height: 700px;
            background: var(--white);
            display: flex;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border-radius: 8px;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 320px;
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        .search-container {
            padding: 20px;
        }

        .search-bar {
            width: 100%;
            padding: 10px 15px;
            border-radius: 20px;
            border: 1px solid var(--border-color);
            background-color: #fafafa;
            outline: none;
        }

        .chat-list {
            flex: 1;
            overflow-y: auto;
        }

        .chat-item {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: background 0.2s;
        }

        .chat-item.active {
            background-color: var(--hover-bg);
        }

        .chat-item:hover {
            background-color: #f9f9f9;
        }

        .chat-info {
            flex: 1;
        }

        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .name-tag {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .user-name {
            font-weight: bold;
            font-size: 14px;
        }

        .tag {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            background: #ffe0c2;
            color: #d35400;
        }

        .tag.normal {
            background: #eee;
            color: #777;
        }

        .time {
            font-size: 11px;
            color: var(--text-gray);
        }

        .last-msg {
            font-size: 12px;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 180px;
        }

        .unread-badge {
            background: var(--primary-orange);
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 5px;
        }

        /* Main Chat Area */
        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-top-bar {
            padding: 15px 25px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .top-user-info .status {
            font-size: 11px;
            color: var(--text-gray);
        }

        .chat-content {
            flex: 1;
            padding: 25px;
            background: white;
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow-y: auto;
        }

        /* Message Bubbles */
        .msg {
            max-width: 70%;
            display: flex;
            flex-direction: column;
        }

        .msg.sent {
            align-self: flex-end;
            align-items: flex-end;
        }

        .bubble {
            padding: 10px 15px;
            border-radius: 15px;
            font-size: 13px;
            line-height: 1.5;
        }

        .sent .bubble {
            background: var(--primary-orange);
            color: white;
            border-bottom-right-radius: 2px;
        }

        .received .bubble {
            background: #f0f0f0;
            color: #333;
            border-bottom-left-radius: 2px;
        }

        .msg-time {
            font-size: 10px;
            color: var(--text-gray);
            margin-top: 5px;
        }

        /* Input Area */
        .input-area {
            padding: 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .input-box {
            flex: 1;
            padding: 12px 20px;
            border-radius: 25px;
            border: 1px solid var(--border-color);
            outline: none;
            background: #fafafa;
        }

        .send-btn {
            background: var(--primary-orange);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="sidebar">
            <div class="search-container">
                <input type="text" class="search-bar" placeholder="대화 검색">
            </div>
            <div class="chat-list" id="chatListUl">
                <div th:each="room : ${chatList}"
                     class="chat-item"
                     th:classappend="${room.roomId == selectedRoomId} ? 'active' : ''"
                     th:data-room-id="${room.roomId}"
                     th:data-nickname="${room.nickName}"
                     th:data-title="${room.title}">

                    <div class="chat-info">
                        <div class="chat-header">
                            <div class="name-tag">
                                <span class="user-name" th:text="${room.nickName}">상대방 이름</span>
                                <span class="tag" th:text="${room.roomType}">GOODS</span>
                            </div>
                            <span class="time" th:text="${room.title}">상품명</span>
                        </div>
                        <div class="last-msg">채팅을 시작해보세요.</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="chat-main">
            <div class="chat-top-bar">
                <div class="top-user-info">
                    <div class="user-name" id="currentChatName">대상을 선택해주세요</div>
                    <div class="status" id="currentChatStatus">대화방에 입장하면 상태가 표시됩니다.</div>
                </div>
            </div>

            <div class="chat-content" id="chatContent">
            </div>

            <div class="input-area">
                <input type="text" class="input-box" id="msgInput" placeholder="메시지를 입력하세요...">
                <button class="send-btn" id="sendBtn">➤</button>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        let ws;
        let currentRoomId = null;
        const myId = [[${session.user.id}]];

        $(document).ready(function() {
            connectWebSocket();

            $(document).on('click', '.chat-item', function() {
                const roomId = $(this).data('room-id');
                const nickName = $(this).data('nickname');
                const title = $(this).data('title');
                console.log(title);
                console.log(roomId);
                console.log(nickName);

                if (currentRoomId === roomId) return;

                $('.chat-item').removeClass('active');
                $(this).addClass('active');
                $('#currentChatName').text(nickName);
                $('#currentChatStatus').text(title);

                currentRoomId = roomId;
                // 순서 중요: UI를 비우고 기록을 로드한 뒤 입장 알림
                enterRoom(roomId);
            });

            $('#sendBtn').on('click', function(){

                if(currentRoomId == null){
                    alert("현재 선택된 방이 없습니다");
                    return;
                }
                if(myId == null){
                    alert("로그인이 안되어 있습니다. 재로그인하세요");
                    return;
                }

                sendMessage();

            });

            $('#msgInput').on('keypress', function(e) {

                if(currentRoomId == null){
                    alert("현재 선택된 방이 없습니다");
                    return;
                }
                if(myId == null){
                    alert("로그인이 안되어 있습니다. 재로그인하세요");
                    return;
                }

                if (e.key === 'Enter') {
                    e.preventDefault();
                    sendMessage();
                }
            });

            const selectedRoomId = [[${selectedRoomId}]];
            if (selectedRoomId) {
                $(`.chat-item[data-room-id="${selectedRoomId}"]`).trigger('click');
            }
        });

        function connectWebSocket() {
            ws = new WebSocket("ws://" + location.host + "/ws/chat");

            ws.onopen = () => console.log("WebSocket Connected ✅");

            ws.onmessage = function(event) {
                console.log("서버로부터 메시지 수신:", event.data);
                const data = JSON.parse(event.data);

                // 실시간 수신 조건: 메시지의 roomId와 현재 활성화된 roomId가 일치할 때
                if(Number(data.roomId) === Number(currentRoomId)) {
                    if (data.type === 'TALK') {
                        console.log(data);
                        displayMessage(data);
                    }
                }
            };

            ws.onclose = () => {
                console.log("WebSocket Disconnected. Retrying...");
                setTimeout(connectWebSocket, 2000);
            };
        }

        function enterRoom(roomId) {
            $('#chatContent').html('');

            // 1. 과거 기록 먼저 로드
            loadChatHistory(roomId);

            // 2. 서버에 이 방에 입장했음을 알림 (서버 세션에 roomId 저장 목적)
            const enterMsg = {
                type: 'ENTER',
                roomId: roomId,
                senderId: myId,
                message: ""
            };

            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(enterMsg));
            }
        }

        function sendMessage() {
            const $input = $('#msgInput');
            const messageText = $input.val().trim();

            if (!messageText || !currentRoomId) return;

            const talkMsg = {
                type: 'TALK',
                roomId: currentRoomId,
                senderId: myId,
                message: messageText
            };

            // 서버로 전송 (서버를 거쳐서 돌아오는 메시지를 displayMessage에서 처리)
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(talkMsg));
                $input.val("").focus();
            } else {
                alert("연결이 끊겨 있습니다. 잠시 후 다시 시도해주세요.");
            }
        }

        function displayMessage(data) {
            if (data.type !== 'TALK') return;

            const isMe = Number(data.senderId) === Number(myId);
            const msgClass = isMe ? 'sent' : 'received';

            let formattedTime;
            if (data.createdAt) {
                const date = new Date(data.createdAt);
                formattedTime = (date.getHours() >= 12 ? '오후 ' : '오전 ')
                    + (date.getHours() % 12 || 12) + ":" + date.getMinutes().toString().padStart(2, '0');
            } else {
                const now = new Date();
                formattedTime = (now.getHours() >= 12 ? '오후 ' : '오전 ') + (now.getHours() % 12 || 12) + ":" + now.getMinutes().toString().padStart(2, '0');
            }

            const msgHtml = `
            <div value="${data.messageId}" class="msg ${msgClass}">
                <div class="bubble">${data.message}</div>
                <span class="msg-time">${formattedTime}</span>
            </div>
        `;

            $('#chatContent').append(msgHtml);
            $('#chatContent').scrollTop($('#chatContent')[0].scrollHeight);
        }

        function displayHistoryMessage(data) {
            if (data.type !== 'TALK') return;

            const isMe = Number(data.senderId) === Number(myId);
            const msgClass = isMe ? 'sent' : 'received';

            let formattedTime;
            if (data.createdAt) {
                const date = new Date(data.createdAt);
                formattedTime = (date.getHours() >= 12 ? '오후 ' : '오전 ')
                    + (date.getHours() % 12 || 12) + ":" + date.getMinutes().toString().padStart(2, '0');
            } else {
                const now = new Date();
                formattedTime = (now.getHours() >= 12 ? '오후 ' : '오전 ') + (now.getHours() % 12 || 12) + ":" + now.getMinutes().toString().padStart(2, '0');
            }

            const msgHtml = `
            <div value="${data.messageId}" class="msg ${msgClass}">
                <div class="bubble">${data.message}</div>
                <span class="msg-time">${formattedTime}</span>
            </div>
        `;

            $('#chatContent').prepend(msgHtml);
            $('#chatContent').scrollTop($('#chatContent')[0].scrollHeight);
        }


        let isChatLoading = false; // 중복 로딩 방지 플래그

        function loadChatHistory(roomId) {
            // 기존 스크롤 이벤트 해제 후 다시 등록 (방 변경 시 중복 등록 방지)
            $(".chat-content").off("scroll").on("scroll", function() {
                let $window = $(this);
                let scrollTop = $window.scrollTop();

                if (scrollTop <= 5 && !isChatLoading) {
                    let firstMsg = $(".msg").first();
                    let lastMsgId = firstMsg.attr("value");

                    if (!lastMsgId) return;

                    isChatLoading = true; // 로딩 시작

                    // 처음 스크롤 저장
                    const previousHeight = $window[0].scrollHeight;

                    $.ajax({
                        url: "/chat/message",
                        method: "get",
                        data: { "roomId": roomId, "messageId": lastMsgId },
                        success: function(messages) {
                            if (messages && messages.length > 0) {
                                messages.forEach(function(msg) {
                                    displayHistoryMessage({
                                        messageId: msg.id,
                                        senderId: msg.senderId,
                                        message: msg.message,
                                        type: 'TALK',
                                        createdAt: msg.createdAt
                                    }, false); // 스크롤 하단 이동 방지 옵션 추가
                                });

                                // 메세지 생성후 높이 저장
                                const newHeight = $window[0].scrollHeight;


                                // 메세지 로드된후 높이 에서 전에 높이 빼기
                                $window.scrollTop(newHeight - previousHeight);
                            }
                            isChatLoading = false; // 로딩 종료
                        },
                        error: function(xhr) {
                            console.error("과거 기록 로드 실패:", xhr.status);
                            isChatLoading = false;
                        }
                    });
                }
            });

            $.ajax({
                url: '/chat/messages/' + roomId,
                method: 'GET',
                success: function(messages) {
                    messages.forEach(function(msg) {
                        displayMessage({
                            messageId:msg.id,
                            senderId: msg.senderId,
                            message: msg.message,
                            type: 'TALK',
                            createdAt: msg.createdAt
                        });
                    });
                    console.log("과거리스트" + messages);
                    console.log("과거 내역 로드 완료:", messages.length, "개");
                },
                error: function(xhr) {
                    console.error("과거 기록 로드 실패. 상태코드:", xhr.status);
                }
            });


        }
    </script>
</body>
</html>